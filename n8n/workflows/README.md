# IMP n8n Workflows - Phase 1 Implementation

## Overview
**Generated by Copilot**

This directory contains the complete set of n8n workflows for **Islamic Manpower Promoters (IMP)** Phase 1 implementation, following the exact specifications from the README.md.

## Phase 1 Workflows Architecture

### Core Processing Pipeline
```
Document Upload → Quality Assessment → Smart Router
    ↓                    ↓              ↓
File Validation     Quality Scoring   Route Decision
    ↓                    ↓              ↓
Metadata Storage    Tier Assignment   Next Workflow
    ↓                    ↓              ↓
    └────── Classification ──────────────┤
                    ↓              
            Data Extraction Primary
                    ↓
            Completion/Validation
```

## Workflow Descriptions

### 1. Document_Upload_Handler.json
**Purpose**: Universal file handler with drag-and-drop support
**Webhook**: `/upload` (POST)
**Features**:
- ✅ File validation (format, size, integrity)
- ✅ Metadata extraction and storage
- ✅ Support for all formats (PDF, Word, Images)
- ✅ Automatic quality assessment trigger
- ✅ Error handling and user feedback

**Supported Formats**:
- PDF documents
- Word documents (.doc, .docx)
- Images (JPG, PNG, TIFF, BMP)
- Maximum file size: 50MB

### 2. Quality_Assessment.json
**Purpose**: Quality scoring using image analysis APIs (simulated in Phase 1)
**Webhook**: `/quality/assess` (POST)
**Features**:
- ✅ Image quality analysis simulation
- ✅ Quality scoring (0-100)
- ✅ Processing tier assignment (High/Medium/Low)
- ✅ Smart routing preparation
- ✅ Cost estimation

**Quality Thresholds** (from README):
- **≥75**: High Quality - Fully automated processing
- **50-74**: Medium Quality - Enhanced processing + validation
- **<50**: Low Quality - Human verification required

### 3. Document_Classification.json
**Purpose**: Document type classification via HuggingFace Donut API (simulated)
**Webhook**: `/classify` (POST)
**Features**:
- ✅ Document type classification
- ✅ HuggingFace Donut simulation
- ✅ Confidence scoring
- ✅ Multiple classification methods
- ✅ Extraction hints generation

**Supported Document Types**:
- CV/Resume
- Passport
- Educational Certificate
- Experience Letter
- CNIC/National ID
- Medical Certificate
- Training Certificate
- Reference Letter

### 4. Data_Extraction_Primary.json
**Purpose**: Basic data extraction workflows
**Webhook**: `/extract` (POST)
**Features**:
- ✅ AI-powered extraction (simulated)
- ✅ Hybrid extraction for medium quality
- ✅ Basic OCR for low quality
- ✅ Field-specific extraction
- ✅ Confidence scoring and validation

**Extraction Methods**:
1. **AI-Powered**: High quality documents (≥75) - simulated HuggingFace Donut
2. **Hybrid**: Medium quality (50-74) - OCR + pattern matching
3. **Basic OCR**: Low quality (<50) - simple text extraction

### 5. Smart_Router.json
**Purpose**: Quality-based smart routing logic
**Webhook**: `/route` (POST)
**Features**:
- ✅ Intelligent routing decisions
- ✅ Processing tier management
- ✅ Cost optimization
- ✅ Workflow orchestration
- ✅ Statistics tracking

**Routing Logic**:
- **High Quality + High Confidence**: Automated processing
- **Medium Quality**: Enhanced processing + validation
- **Low Quality/Confidence**: Human review queue

## Installation & Setup

### Prerequisites
- n8n instance running (via Docker Compose)
- PostgreSQL database (configured in docker-compose.yml)
- FastAPI backend running on port 8000

### Import Workflows

1. **Start n8n instance**:
```powershell
# From project root
docker-compose up -d imp-n8n
```

2. **Access n8n interface**:
```
URL: http://localhost:5678
Username: admin
Password: admin123
```

3. **Import workflows**:
- Go to n8n interface
- Click "Import from file"
- Import each JSON file in order:
  1. `Document_Upload_Handler.json`
  2. `Quality_Assessment.json` 
  3. `Document_Classification.json`
  4. `Data_Extraction_Primary.json`
  5. `Smart_Router.json`

### Webhook URLs

After importing, the following webhooks will be available:

| Workflow | Webhook URL | Method | Purpose |
|----------|-------------|---------|---------|
| Document Upload | `http://localhost:5678/webhook/imp-upload-handler` | POST | File upload |
| Quality Assessment | `http://localhost:5678/webhook/imp-quality-assessment` | POST | Quality scoring |
| Classification | `http://localhost:5678/webhook/imp-classification` | POST | Document classification |
| Data Extraction | `http://localhost:5678/webhook/imp-data-extraction` | POST | Data extraction |
| Smart Router | `http://localhost:5678/webhook/imp-smart-router` | POST | Routing decisions |

## Testing the Workflows

### 1. Test Document Upload
```powershell
# Upload a test document
curl -X POST "http://localhost:5678/webhook/imp-upload-handler" `
  -H "Content-Type: multipart/form-data" `
  -F "file=@test_document.pdf"
```

### 2. Test Quality Assessment
```powershell
# Test quality assessment
curl -X POST "http://localhost:5678/webhook/imp-quality-assessment" `
  -H "Content-Type: application/json" `
  -d '{
    "document": {
      "id": "doc_123",
      "mime_type": "application/pdf",
      "file_size_mb": 2.5
    }
  }'
```

### 3. Test Complete Pipeline
```powershell
# Test end-to-end processing
curl -X POST "http://localhost:8000/api/v1/documents/upload" `
  -F "file=@sample_cv.pdf"
```

## Workflow Configuration

### Environment Variables
Each workflow uses these environment variables:
```env
# FastAPI Backend
FASTAPI_URL=http://imp-fastapi:8000

# Webhook URLs
WEBHOOK_BASE_URL=http://localhost:5678/webhook

# Processing Thresholds
QUALITY_THRESHOLD_HIGH=75
QUALITY_THRESHOLD_MEDIUM=50

# Cost Estimates (from README)
COST_HIGH_QUALITY=0.02
COST_MEDIUM_QUALITY=0.15
COST_LOW_QUALITY=0.25
```

### Database Integration
Workflows integrate with PostgreSQL via FastAPI endpoints:
- Document metadata storage
- Quality assessment results
- Classification results
- Extraction data
- Processing statistics

## Monitoring & Debugging

### n8n Execution Logs
- View execution history in n8n interface
- Check individual node outputs
- Monitor webhook triggers
- Debug failed executions

### Workflow Status Monitoring
```javascript
// Check workflow execution status
GET http://localhost:5678/rest/executions

// Get specific execution details  
GET http://localhost:5678/rest/executions/{executionId}
```

### Processing Statistics
Each workflow updates processing statistics:
- Document processing time
- Quality scores distribution
- Classification accuracy
- Extraction success rates
- Cost tracking

## Cost Optimization

### Processing Tier Distribution (Expected)
- **High Quality (75%)**: $0.02 per document
- **Medium Quality (20%)**: $0.15 per document  
- **Low Quality (5%)**: $0.25 per document

### Average Cost per Document
```
Expected: (75% × $0.02) + (20% × $0.15) + (5% × $0.25) = $0.0575
```

## Phase 2 Integration Points

### Workflow Enhancement Areas
1. **Quality_Assessment.json**: 
   - Replace simulation with real image analysis APIs
   - Add Google Vision API integration
   - Implement actual blur/contrast detection

2. **Document_Classification.json**:
   - Replace simulation with HuggingFace Donut API calls
   - Add model fine-tuning capabilities
   - Implement confidence threshold optimization

3. **Data_Extraction_Primary.json**:
   - Integrate real HuggingFace Donut models
   - Add Google Cloud Vision fallback
   - Implement OpenAI GPT-4V for complex documents

4. **Smart_Router.json**:
   - Add machine learning-based routing optimization
   - Implement cost prediction models
   - Add advanced analytics and reporting

## Troubleshooting

### Common Issues

1. **Webhook not triggering**:
   - Check workflow is active
   - Verify webhook URL in n8n interface
   - Ensure n8n is running and accessible

2. **Node execution errors**:
   - Check JavaScript code syntax
   - Verify input data structure
   - Review node configuration

3. **FastAPI integration issues**:
   - Ensure FastAPI backend is running
   - Check API endpoint URLs
   - Verify authentication if required

4. **Database connection problems**:
   - Check PostgreSQL is running
   - Verify database credentials
   - Ensure database schema is created

### Debug Mode
Enable debug mode in n8n:
```env
N8N_LOG_LEVEL=debug
```

## Support & Documentation

### Resources
- [n8n Documentation](https://docs.n8n.io/)
- [n8n Community Forum](https://community.n8n.io/)
- [Workflow Best Practices](https://docs.n8n.io/workflows/best-practices/)

### Custom Node Development
For Phase 2, consider developing custom n8n nodes for:
- HuggingFace integration
- Image analysis APIs
- Advanced OCR engines
- Custom ML models

---

**Generated by Copilot** - IMP Phase 1 n8n Workflows Implementation
**Version**: 1.0.0 
**Last Updated**: 2025-07-04
